# ... existing code ...
    def search_item_thread(self, query):
        """
        å•Ÿå‹•æœå°‹åŸ·è¡Œç·’ (Entry Point)
        """
        # æ¸…ç©ºèˆŠçš„é¡¯ç¤º (å¯ä»¥åœ¨ä¸»åŸ·è¡Œç·’åš)
        self.btn_search.configure(state="disabled")
        self.status_label.configure(text="ğŸ” æœå°‹ä¸­...")
        self.scan_tree.delete(*self.scan_tree.get_children())

        # å•Ÿå‹•èƒŒæ™¯å·¥ä½œï¼Œå‚³å…¥æŸ¥è©¢å­—ä¸²
        threading.Thread(target=self._run_search_task, args=(query,), daemon=True).start()

    def _run_search_task(self, query):
        """
        [èƒŒæ™¯åŸ·è¡Œç·’] åªè² è²¬æŠ“è³‡æ–™èˆ‡è¨ˆç®—ï¼Œçµ•å°ä¸ç¢° UI
        """
        try:
            # 1. åŸ·è¡Œ API æœå°‹ (è€—æ™‚æ“ä½œ)
            # æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ market_api è£¡é¢çš„ search_item_web
            # å¦‚æœæ‚¨æœ‰è‡ªè¨‚çš„é‚è¼¯ï¼Œè«‹å°‡çµæœæ•´ç†æˆ list
            # å‡è¨­æ‚¨çš„ market_api å›å‚³çš„æ˜¯æ¨™æº–æ ¼å¼
            
            # æ¨¡æ“¬æ‚¨çš„æ—¥èªŒ
            logging.info(f"é–‹å§‹æœå°‹: {query}")
            
            # é€™è£¡å‘¼å«æ‚¨çš„ API é‚è¼¯ (è«‹ä¾æ“šæ‚¨å¯¦éš›çš„è®Šæ•¸åç¨±èª¿æ•´)
            # å‡è¨­ search_item_web å›å‚³çš„æ˜¯ä¸€å€‹åŒ…å« item_id çš„åˆ—è¡¨
            results = self.market_api.search_item_web(query)
            
            if not results:
                self.append_log("æ‰¾ä¸åˆ°ç›¸é—œç‰©å“ã€‚")
                self.after(0, lambda: self._search_finished([], "æ‰¾ä¸åˆ°ç‰©å“"))
                return

            logging.info("æˆåŠŸç²å–æ•¸æ“šï¼Œé–‹å§‹åˆ†æ...")

            # 2. é å…ˆè™•ç†è¦é¡¯ç¤ºçš„è³‡æ–™ (åŒ…å«è£½ä½œåˆ¤å®š)
            display_data = []
            
            # å–å¾—ç›®å‰çš„ä¼ºæœå™¨è¨­å®š
            current_server = self.server_var.get()

            for item in results:
                item_id = item.get('id')
                item_name = item.get('name')
                
                # åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸­é å…ˆè¨ˆç®— Crafting ç‹€æ…‹
                # é€™æ¨£å°±ä¸æœƒå¡ä½ UI
                crafting_info = self.crafting_service.get_crafting_data(item_id, current_server)
                
                # æ‚¨çš„æ—¥èªŒåœ¨é€™è£¡è¢«è§¸ç™¼
                logging.debug(f"CRAFTING_RESULT: {crafting_info.get('status')}")
                
                # åˆ¤æ–·é¡¯ç¤ºæ–‡å­—
                craft_status_text = "âŒ ç„¡æ³•è£½ä½œ"
                if crafting_info.get('status') != 'no_recipe':
                    craft_status_text = "ğŸ”¨ å¯è£½ä½œ"

                # å°‡æ•´ç†å¥½çš„æ•¸æ“šå­˜å…¥åˆ—è¡¨
                # é€™è£¡åªå­˜æ•¸æ“šï¼Œä¸å‘¼å« tree.insert
                display_data.append({
                    'id': item_id,
                    'name': item_name,
                    'craft_status': craft_status_text,
                    'price_info': item.get('price_info', '---') # å‡è¨­æœ‰é€™æ¬„ä½
                })

            # 3. æ•¸æ“šè™•ç†å®Œæˆï¼Œå‘¼å«ä¸»åŸ·è¡Œç·’æ›´æ–° UI
            # ä½¿ç”¨ self.after(0, ...) å°‡æ§åˆ¶æ¬Šäº¤é‚„çµ¦ä¸»åŸ·è¡Œç·’
            self.after(0, lambda: self._update_search_ui(display_data))

        except Exception as e:
            logging.error(f"æœå°‹ç™¼ç”ŸéŒ¯èª¤: {e}")
            self.after(0, lambda: self._search_finished([], f"éŒ¯èª¤: {e}"))

    def _update_search_ui(self, display_data):
        """
        [ä¸»åŸ·è¡Œç·’] è² è²¬æ¥æ”¶æ•¸æ“šä¸¦æ›´æ–° Treeview
        """
        try:
            # å†æ¬¡ç¢ºä¿æ¸…ç©º (ä»¥é˜²è¬ä¸€)
            self.scan_tree.delete(*self.scan_tree.get_children())

            if not display_data:
                self.status_label.configure(text="ç„¡çµæœ")
            else:
                self.status_label.configure(text=f"æ‰¾åˆ° {len(display_data)} ç­†çµæœ")

            # å®‰å…¨åœ°æ›´æ–° UI
            for data in display_data:
                self.scan_tree.insert(
                    "", 
                    "end", 
                    values=(
                        data['id'], 
                        data['name'], 
                        data['craft_status'],
                        data['price_info']
                    )
                )
                
            self.append_log(f"æœå°‹å®Œæˆï¼Œæ›´æ–° {len(display_data)} ç­†è³‡æ–™ã€‚")
            
        except Exception as e:
            logging.error(f"UI æ›´æ–°å¤±æ•—: {e}")
        finally:
            # æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            self.btn_search.configure(state="normal")

    def _search_finished(self, results, msg):
        """
        éŒ¯èª¤æˆ–ç©ºçµæœçš„ç°¡å–®å›èª¿
        """
        self.status_label.configure(text=msg)
        self.btn_search.configure(state="normal")

# ... existing code ...