"""
FF14 ç‰©å“å¿«å–è‡ªå‹•æ›´æ–°å·¥å…·
=============================
åŠŸèƒ½ï¼š
1. å¾ Cafemaker API æ‰¹é‡æŠ“å–æœ€æ–°ç‰©å“åç¨±
2. è‡ªå‹•é€²è¡Œç°¡é«”ä¸­æ–‡ â†’ ç¹é«”ä¸­æ–‡è½‰æ›
3. æ›´æ–° items_cache_tw.json
4. è‡ªå‹•ç‚ºè—å¯¶åœ–æ–°å¢ G ç·¨è™Ÿåˆ¥å

ä½¿ç”¨æ–¹å¼ï¼š
  python update_items_cache.py              # å®Œæ•´æ›´æ–°ï¼ˆå¢é‡æ¨¡å¼ï¼‰
  python update_items_cache.py --full       # å®Œæ•´é‡å»º
  python update_items_cache.py --maps-only  # åªæ›´æ–°è—å¯¶åœ–åˆ¥å
  python update_items_cache.py --dry-run    # é è¦½æ¨¡å¼ï¼ˆä¸å¯«å…¥æª”æ¡ˆï¼‰
"""

import json
import os
import sys
import time
import logging
import argparse
from datetime import datetime

# å˜—è©¦åŒ¯å…¥ requestsï¼ˆå¿…é ˆï¼‰
try:
    import requests
    from requests.adapters import HTTPAdapter
    from urllib3.util.retry import Retry
except ImportError:
    print("[éŒ¯èª¤] éœ€è¦ requests å¥—ä»¶ã€‚è«‹åŸ·è¡Œ: pip install requests")
    sys.exit(1)

# ==========================================
# ç°¡é«” â†’ ç¹é«” è½‰æ›æ¨¡çµ„ï¼ˆå…§å»ºå°ç…§è¡¨ï¼‰
# ==========================================

# å¸¸è¦‹çš„ç°¡ç¹å·®ç•°å­—å°ç…§è¡¨ï¼ˆé‡å° FF14 ç‰©å“åç¨±å„ªåŒ–ï¼‰
# æ ¼å¼ï¼šç°¡é«”å­— â†’ ç¹é«”å­—
SIMPLIFIED_TO_TRADITIONAL = {
    # é€šç”¨å°ç…§
    'ä¸': 'èˆ‡', 'ä¸“': 'å°ˆ', 'ä¸š': 'æ¥­', 'ä¸›': 'å¢', 'ä¸œ': 'æ±',
    'ä¸': 'çµ²', 'ä¸¢': 'ä¸Ÿ', 'ä¸¤': 'å…©', 'ä¸¥': 'åš´', 'ä¸§': 'å–ª',
    'ä¸ª': 'å€‹', 'ä¸°': 'è±', 'ä¸´': 'è‡¨', 'ä¸º': 'ç‚º', 'ä¸½': 'éº—',
    'ä¸¾': 'èˆ‰', 'ä¹‰': 'ç¾©', 'ä¹Œ': 'çƒ', 'ä¹': 'æ¨‚', 'ä¹”': 'å–¬',
    'ä¹ ': 'ç¿’', 'ä¹¦': 'æ›¸', 'ä¹°': 'è²·', 'ä¹±': 'äº‚', 'äº‰': 'çˆ­',
    'äº': 'è™§', 'äº‘': 'é›²', 'äºš': 'äº', 'äº§': 'ç”¢', 'äº©': 'ç•',
    'äº²': 'è¦ª', 'äº¿': 'å„„', 'ä»…': 'åƒ…', 'ä»': 'å¾', 'ä»“': 'å€‰',
    'ä»ª': 'å„€', 'ä»¬': 'å€‘', 'ä»·': 'åƒ¹', 'ä¼—': 'çœ¾', 'ä¼˜': 'å„ª',
    'ä¼™': 'å¤¥', 'ä¼š': 'æœƒ', 'ä¼': 'å‚˜', 'ä¼Ÿ': 'å‰', 'ä¼ ': 'å‚³',
    'ä¼¤': 'å‚·', 'ä¼¦': 'å€«', 'ä¼ª': 'å½', 'ä¼¼': 'ä¼¼', 'ä½£': 'å‚­',
    'ä½“': 'é«”', 'ä½™': 'é¤˜', 'ä½›': 'ä½›', 'ä½ ': 'ä½ ', 'ä½©': 'ä½©',
    'ä¾ ': 'ä¿ ', 'ä¾£': 'ä¾¶', 'ä¾¦': 'åµ', 'ä¾§': 'å´', 'ä¾¨': 'åƒ‘',
    'ä¿©': 'å€†', 'å€º': 'å‚µ', 'å€¼': 'å€¼', 'å€¾': 'å‚¾', 'å‡': 'å‡',
    'å¿': 'å„Ÿ', 'å‚¨': 'å„²', 'å‚¬': 'å‚¬', 'åƒ': 'åƒ', 'å„¿': 'å…’',
    'å…‘': 'å…Œ', 'å…š': 'é»¨', 'å…°': 'è˜­', 'å…³': 'é—œ', 'å…´': 'èˆˆ',
    'å…¹': 'èŒ²', 'å…»': 'é¤Š', 'å…½': 'ç¸', 'å†…': 'å…§', 'å†ˆ': 'å²¡',
    'å†Œ': 'å†Š', 'å†›': 'è»', 'å†œ': 'è¾²', 'å†²': 'æ²–', 'å†³': 'æ±º',
    'å†µ': 'æ³', 'å†»': 'å‡', 'å‡€': 'æ·¨', 'å‡‰': 'æ¶¼', 'å‡': 'æ¸›',
    'å‡¤': 'é³³', 'å‡­': 'æ†‘', 'å‡¯': 'å‡±', 'å‡»': 'æ“Š', 'å‡¿': 'é‘¿',
    'åˆŠ': 'åˆŠ', 'åˆ’': 'åŠƒ', 'åˆ˜': 'åŠ‰', 'åˆ™': 'å‰‡', 'åˆš': 'å‰›',
    'åˆ›': 'å‰µ', 'åˆ': 'åˆ', 'åˆ ': 'åˆª', 'åˆ«': 'åˆ¥', 'åˆ®': 'åˆ®',
    'åˆ¶': 'è£½', 'åˆ¹': 'å‰', 'å‰‚': 'åŠ‘', 'å‰‘': 'åŠ', 'å‰§': 'åŠ‡',
    'å‰©': 'å‰©', 'å‰ª': 'å‰ª', 'å‰¯': 'å‰¯', 'å‰²': 'å‰²', 'åŠ': 'å‹¸',
    'åŠ': 'è¾¦', 'åŠ¡': 'å‹™', 'åŠ¨': 'å‹•', 'åŠ±': 'å‹µ', 'åŠ²': 'å‹',
    'åŠ³': 'å‹', 'åŠ¿': 'å‹¢', 'å‹‹': 'å‹³', 'å‹¤': 'å‹¤', 'å‹¾': 'å‹¾',
    'åŒ…': 'åŒ…', 'åŒ ': 'åŒ ', 'åŒº': 'å€', 'åŒ»': 'é†«', 'å': 'è¯',
    'å': 'å”', 'å•': 'å–®', 'å–': 'è³£', 'å ': 'ä½”', 'å«': 'è¡›',
    'å·': 'å·', 'å‚': 'å» ', 'å…': 'å»³', 'å†': 'æ­·', 'å‰': 'å²',
    'å‹': 'å£“', 'åŒ': 'å­', 'å¨': 'å»š', 'å©': 'å»„', 'å»': 'å»',
    'å¿': 'ç¸£', 'å‚': 'åƒ', 'å”': 'å”', 'åŒ': 'é›™', 'å‘': 'ç™¼',
    'å˜': 'è®Š', 'å™': 'æ•˜', 'å ': 'ç–Š', 'åª': 'åª', 'å°': 'å°',
    'å·': 'è™Ÿ', 'å¹': 'å˜†', 'åŠ': 'å¼”', 'å': 'å¾Œ', 'å“': 'åš‡',
    'å•': 'å‘‚', 'å—': 'å—', 'å¬': 'è½', 'å¯': 'å•Ÿ', 'å‘': 'å¶',
    'å‘•': 'å˜”', 'å‘›': 'å—†', 'å‘˜': 'å“¡', 'å‘œ': 'å—š', 'å’': 'è© ',
    'å’¨': 'è«®', 'å“': 'éŸ¿', 'å“‘': 'å•', 'å“—': 'å˜©', 'å“Ÿ': 'å–²',
    'å”¤': 'å–š', 'å•¬': 'å—‡', 'å•¸': 'å˜¯', 'å–·': 'å™´', 'å˜±': 'å›‘',
    'å™œ': 'åš•', 'å˜´': 'å˜´', 'å™¨': 'å™¨', 'å›´': 'åœ', 'å›­': 'åœ’',
    'å›½': 'åœ‹', 'å›¾': 'åœ–', 'åœ†': 'åœ“', 'åœ£': 'è–', 'åœº': 'å ´',
    'å': 'å£', 'å—': 'å¡Š', 'åš': 'å …', 'å›': 'å£‡', 'å': 'å£©',
    'å ': 'å¢œ', 'å’': 'å£˜', 'å¦': 'å¢¾', 'å«': 'å¢Š', 'å³': 'å³',
    'åŸ˜': 'å¡’', 'åŸ': 'åŸ', 'åŸŸ': 'åŸŸ', 'åŸ¹': 'åŸ¹', 'å •': 'å¢®',
    'å ¡': 'å ¡', 'å¡”': 'å¡”', 'å¡˜': 'å¡˜', 'å¢™': 'ç‰†', 'å£®': 'å£¯',
    'å£°': 'è²', 'å£³': 'æ®¼', 'å¤„': 'è™•', 'å¤‡': 'å‚™', 'å¤': 'å¾©',
    'å¤Ÿ': 'å¤ ', 'å¤´': 'é ­', 'å¤¸': 'èª‡', 'å¤º': 'å¥ª', 'å¥‹': 'å¥®',
    'å¥–': 'ç', 'å¥¥': 'å¥§', 'å¦†': 'å¦', 'å¦‡': 'å©¦', 'å¦ˆ': 'åª½',
    'å§': 'å§', 'å§‘': 'å§‘', 'å¨˜': 'å¨˜', 'å¨±': 'å¨›', 'å©´': 'å¬°',
    'å«”': 'å¬ª', 'å­': 'å­', 'å­™': 'å­«', 'å­¦': 'å­¸', 'å®': 'å¯§',
    'å®': 'å¯¶', 'å®': 'å¯¦', 'å® ': 'å¯µ', 'å®¡': 'å¯©', 'å®ª': 'æ†²',
    'å®«': 'å®®', 'å®¶': 'å®¶', 'å®½': 'å¯¬', 'å®¾': 'è³“', 'å¯': 'å¯¢',
    'å¯¹': 'å°', 'å¯»': 'å°‹', 'å¯¼': 'å°', 'å°†': 'å°‡', 'å°”': 'çˆ¾',
    'å°˜': 'å¡µ', 'å°': 'åš', 'å°§': 'å ¯', 'å°½': 'ç›¡', 'å±‚': 'å±¤',
    'å±¡': 'å±¢', 'å±': 'å±¬', 'å²': 'æ­²', 'å²‚': 'è±ˆ', 'å²—': 'å´—',
    'å²š': 'åµ', 'å²›': 'å³¶', 'å²­': 'å¶º', 'å²³': 'å¶½', 'å²¸': 'å²¸',
    'å³¡': 'å³½', 'å´­': 'å¶„', 'å·©': 'é', 'å·¨': 'å·¨', 'å¸': 'å¹£',
    'å¸ˆ': 'å¸«', 'å¸…': 'å¸¥', 'å¸¦': 'å¸¶', 'å¸': 'å¸³', 'å¸œ': 'å¹Ÿ',
    'å¸§': 'å¹€', 'å¸®': 'å¹«', 'å¹¿': 'å»£', 'åº†': 'æ…¶', 'åº': 'å»¬',
    'åº™': 'å»Ÿ', 'åº': 'é¾', 'åºŸ': 'å»¢', 'å»Š': 'å»Š', 'å¼€': 'é–‹',
    'å¼‚': 'ç•°', 'å¼ƒ': 'æ£„', 'å¼ ': 'å¼µ', 'å¼¥': 'å½Œ', 'å¼¦': 'å¼¦',
    'å¼¯': 'å½', 'å¼¹': 'å½ˆ', 'å¼º': 'å¼·', 'å½’': 'æ­¸', 'å½“': 'ç•¶',
    'å½•': 'éŒ„', 'å½': 'å½', 'å½¢': 'å½¢', 'å½»': 'å¾¹', 'å¾„': 'å¾‘',
    'å¾': 'å¾', 'å¾¡': 'ç¦¦', 'å¿†': 'æ†¶', 'å¿—': 'å¿—', 'å¿§': 'æ†‚',
    'æ€': 'æ…‹', 'æ€€': 'æ‡·', 'æ€œ': 'æ†', 'æ€»': 'ç¸½', 'æ‹': 'æˆ€',
    'æ’': 'æ†', 'æ³': 'æ‡‡', 'æ¶': 'æƒ¡', 'æ‚¦': 'æ‚…', 'æ‚¬': 'æ‡¸',
    'æ‚¯': 'æ†«', 'æƒŠ': 'é©š', 'æƒ§': 'æ‡¼', 'æƒ¨': 'æ…˜', 'æƒ©': 'æ‡²',
    'æƒ«': 'æ†Š', 'æƒ¬': 'æ„œ', 'æ„¤': 'æ†¤', 'æ…‘': 'æ‡¾', 'æ‡’': 'æ‡¶',
    'æˆ': 'æˆ²', 'æˆ˜': 'æˆ°', 'æˆ¬': 'æˆ©', 'æˆ·': 'æˆ¶', 'æ‰§': 'åŸ·',
    'æ‰‘': 'æ’²', 'æ‰”': 'æ‰”', 'æ‰˜': 'è¨—', 'æ‰©': 'æ“´', 'æ‰«': 'æƒ',
    'æ‰¬': 'æš', 'æ‰°': 'æ“¾', 'æŠ˜': 'æŠ˜', 'æŠš': 'æ’«', 'æŠ›': 'æ‹‹',
    'æŠ¤': 'è­·', 'æŠ¥': 'å ±', 'æ‹…': 'æ“”', 'æ‹Ÿ': 'æ“¬', 'æ‹¢': 'æ”',
    'æ‹£': 'æ€', 'æ‹¥': 'æ“', 'æ‹©': 'æ“‡', 'æŒ‚': 'æ›', 'æŒ¡': 'æ“‹',
    'æŒ£': 'æ™', 'æŒ¤': 'æ“ ', 'æŒ¥': 'æ®', 'æŒ½': 'æŒ½', 'æŸ': 'æ',
    'æ•': 'æ•', 'æ¢': 'æ›', 'æ®': 'æ“š', 'æ·': 'æ“²', 'æ½': 'æ”¬',
    'æ€': 'æ”™', 'æ': 'æ“±', 'æ‚': 'æ‘Ÿ', 'æ…': 'æ”ª', 'æœ': 'æœ',
    'æ‘„': 'æ”', 'æ‘†': 'æ“º', 'æ‘‡': 'æ–', 'æ’‘': 'æ’', 'æ’¤': 'æ’¤',
    'æ’µ': 'æ”†', 'æ“': 'æ“', 'æ“': 'æ“', 'æ”¶': 'æ”¶', 'æ”»': 'æ”»',
    'è´¥': 'æ•—', 'æ•ˆ': 'æ•ˆ', 'æ•Œ': 'æ•µ', 'æ•°': 'æ•¸', 'æ•´': 'æ•´',
    'æ•›': 'æ–‚', 'æ–—': 'é¬¥', 'æ–©': 'æ–¬', 'æ–­': 'æ–·', 'æ— ': 'ç„¡',
    'æ—¢': 'æ—¢', 'æ—¶': 'æ™‚', 'æ—·': 'æ› ', 'æ˜†': 'æ˜†', 'æ˜¼': 'æ™',
    'æ˜¾': 'é¡¯', 'æ™‹': 'æ™‰', 'æ™’': 'æ›¬', 'æ™“': 'æ›‰', 'æ™•': 'æšˆ',
    'æ™–': 'æš‰', 'æš‚': 'æš«', 'æš—': 'æš—', 'æ›²': 'æ›²', 'æœ¯': 'è¡“',
    'æœº': 'æ©Ÿ', 'æƒ': 'æ¬Š', 'æ€': 'æ®º', 'æ‚': 'é›œ', 'æ†': 'æ¡¿',
    'æ¡': 'æ¢', 'æ¥': 'ä¾†', 'æ¨': 'æ¥Š', 'æ': 'æ¥µ', 'æ„': 'æ§‹',
    'æ': 'æ', 'æª': 'æ§', 'æŸœ': 'æ«ƒ', 'æŸ ': 'æª¸', 'æ ‡': 'æ¨™',
    'æ …': 'æŸµ', 'æ ˆ': 'æ£§', 'æ ‹': 'æ£Ÿ', 'æ ·': 'æ¨£', 'æ ¸': 'æ ¸',
    'æ¡ƒ': 'æ¡ƒ', 'æ¡¥': 'æ©‹', 'æ¡£': 'æª”', 'æ¢¦': 'å¤¢', 'æ£€': 'æª¢',
    'æ£‚': 'æ¬', 'æ¥¼': 'æ¨“', 'æ¦„': 'æ¬–', 'æ¦¨': 'æ¦¨', 'æ§›': 'æª»',
    'æ¨ª': 'æ©«', 'æ¨±': 'æ«»', 'æ©±': 'æ«¥', 'æ¬¢': 'æ­¡', 'æ­¼': 'æ®²',
    'æ®‹': 'æ®˜', 'æ®': 'æ­¿', 'æ®‡': 'æ®¤', 'æ¯': 'æ¯€', 'æ¯•': 'ç•¢',
    'æ¯™': 'æ–ƒ', 'æ°”': 'æ°£', 'æ°¢': 'æ°«', 'æ±‡': 'åŒ¯', 'æ±‰': 'æ¼¢',
    'æ±¡': 'æ±¡', 'æ±¤': 'æ¹¯', 'æ²ˆ': 'æ²ˆ', 'æ²‰': 'æ²‰', 'æ²Ÿ': 'æº',
    'æ²¡': 'æ²’', 'æ²¦': 'æ·ª', 'æ²§': 'æ»„', 'æ²ª': 'æ»¬', 'æ³›': 'æ³›',
    'æ³¨': 'æ³¨', 'æ³ª': 'æ·š', 'æ³¼': 'æ½‘', 'æ´': 'æ½”', 'æ´’': 'ç‘',
    'æµ†': 'æ¼¿', 'æµ‡': 'æ¾†', 'æµŠ': 'æ¿', 'æµ‹': 'æ¸¬', 'æµ‘': 'æ¸¾',
    'æµ“': 'æ¿ƒ', 'æµ…': 'æ·º', 'æµ': 'æ¿Ÿ', 'æµª': 'æµª', 'æµ®': 'æµ®',
    'æ¶Œ': 'æ¹§', 'æ¶›': 'æ¿¤', 'æ¶¦': 'æ½¤', 'æ¶©': 'æ¾€', 'æ·€': 'æ¾±',
    'æ¸Š': 'æ·µ', 'æ¸': 'æ¼¸', 'æ¸”': 'æ¼', 'æ¸—': 'æ»²', 'æ¸©': 'æº«',
    'æ¹¾': 'ç£', 'æºƒ': 'æ½°', 'æ»š': 'æ»¾', 'æ»': 'æ»¯', 'æ»¡': 'æ»¿',
    'æ»¤': 'æ¿¾', 'æ»¥': 'æ¿«', 'æ¼“': 'ç•', 'æ½œ': 'æ½›', 'æ½­': 'æ½­',
    'æ¿‘': 'ç€¨', 'ç­': 'æ»…', 'ç¯': 'ç‡ˆ', 'çµ': 'éˆ', 'ç¾': 'ç½',
    'ç¿': 'ç‡¦', 'ç‚‰': 'çˆ', 'ç‚': 'ç‚', 'ç‚®': 'ç‚®', 'ç‚¼': 'ç…‰',
    'çƒ': 'çˆ', 'çƒ‚': 'çˆ›', 'çƒ›': 'ç‡­', 'çƒŸ': 'ç…™', 'çƒ¦': 'ç…©',
    'çƒ§': 'ç‡’', 'çƒ«': 'ç‡™', 'çƒ­': 'ç†±', 'ç„•': 'ç…¥', 'ç„°': 'ç„°',
    'ç…': 'ç…', 'ç†': 'ç‡»', 'çˆ±': 'æ„›', 'ç‰': 'ç‰˜', 'çŠ¶': 'ç‹€',
    'çŠ¹': 'çŒ¶', 'ç‹ˆ': 'ç‹½', 'ç‹': 'ç°', 'ç‹¬': 'ç¨', 'ç‹®': 'ç…',
    'çŒ': 'çµ', 'çŒª': 'è±¬', 'çŒ«': 'è²“', 'çŒ®': 'ç»', 'çŒ´': 'çŒ´',
    'ç‘': 'ç’£', 'ç¯': 'ç’°', 'ç°': 'ç¾', 'ç›': 'ç‘ª', 'ç': 'çº',
    'ç‘': 'ç“', 'ç²': 'ç¿', 'ç‘¶': 'ç‘¤', 'ç’ƒ': 'ç’ƒ', 'ç“®': 'ç”•',
    'ç”µ': 'é›»', 'ç”»': 'ç•«', 'ç•…': 'æš¢', 'å¼‚': 'ç•°', 'ç–—': 'ç™‚',
    'ç–®': 'ç˜¡', 'ç–¯': 'ç˜‹', 'ç—‡': 'ç—‡', 'ç—’': 'ç™¢', 'ç—•': 'ç—•',
    'ç˜«': 'ç™±', 'ç˜¾': 'ç™®', 'ç›': 'ç›', 'ç›': 'é¹½', 'ç›‘': 'ç›£',
    'ç›–': 'è“‹', 'ç›˜': 'ç›¤', 'ç›¾': 'ç›¾', 'çœ‰': 'çœ‰', 'ç€': 'è‘—',
    'ç': 'çœ', 'ç': 'ç', 'ç’': 'ç', 'çŸ›': 'çŸ›', 'çŸ«': 'çŸ¯',
    'ç –': 'ç£š', 'ç¡€': 'ç¤', 'ç¡®': 'ç¢º', 'ç¡•': 'ç¢©', 'ç¢': 'ç¤™',
    'ç¢—': 'ç¢—', 'ç¢›': 'ç£§', 'ç£': 'ç£', 'ç¤¼': 'ç¦®', 'ç¥': 'ç¥',
    'ç¥': 'ç¥', 'ç¥¸': 'ç¦', 'ç¦…': 'ç¦ª', 'ç¦»': 'é›¢', 'ç§': 'ç¨®',
    'ç§¯': 'ç©', 'ç§°': 'ç¨±', 'ç§˜': 'ç§˜', 'ç§©': 'ç§©', 'ç¨': 'ç¨…',
    'ç¨³': 'ç©©', 'ç©·': 'çª®', 'çªƒ': 'ç«Š', 'çª': 'ç«…', 'çª': 'çª©',
    'çª¥': 'çªº', 'ç«': 'ç«¶', 'ç¬”': 'ç­†', 'ç¬¼': 'ç± ', 'ç­‘': 'ç¯‰',
    'ç­': 'ç®', 'ç­–': 'ç­–', 'ç­¾': 'ç°½', 'ç®€': 'ç°¡', 'ç®±': 'ç®±',
    'ç¯®': 'ç±ƒ', 'ç±»': 'é¡', 'ç²®': 'ç³§', 'ç³™': 'ç³™', 'çº ': 'ç³¾',
    'çº¢': 'ç´…', 'çº¤': 'çº–', 'çº¦': 'ç´„', 'çº§': 'ç´š', 'çºª': 'ç´€',
    'çº«': 'ç´‰', 'çº¬': 'ç·¯', 'çº¯': 'ç´”', 'çº±': 'ç´—', 'çº²': 'ç¶±',
    'çº³': 'ç´', 'çºµ': 'ç¸±', 'çº·': 'ç´›', 'çº¸': 'ç´™', 'çº¹': 'ç´‹',
    'çºº': 'ç´¡', 'çº½': 'ç´', 'çº¿': 'ç·š', 'ç»ƒ': 'ç·´', 'ç»„': 'çµ„',
    'ç»†': 'ç´°', 'ç»‡': 'ç¹”', 'ç»ˆ': 'çµ‚', 'ç»': 'ç´¹', 'ç»': 'ç¶“',
    'ç»‘': 'ç¶', 'ç»“': 'çµ', 'ç»•': 'ç¹', 'ç»˜': 'ç¹ª', 'ç»™': 'çµ¦',
    'ç»œ': 'çµ¡', 'ç»': 'çµ•', 'ç»Ÿ': 'çµ±', 'ç»§': 'ç¹¼', 'ç»©': 'ç¸¾',
    'ç»ª': 'ç·’', 'ç»­': 'çºŒ', 'ç»®': 'ç¶º', 'ç»¯': 'ç·‹', 'ç»°': 'ç¶½',
    'ç»³': 'ç¹©', 'ç»´': 'ç¶­', 'ç»µ': 'ç¶¿', 'ç»¼': 'ç¶œ', 'ç»¿': 'ç¶ ',
    'ç¼€': 'ç¶´', 'ç¼…': 'ç·¬', 'ç¼†': 'çºœ', 'ç¼”': 'ç· ', 'ç¼•': 'ç¸·',
    'ç¼–': 'ç·¨', 'ç¼˜': 'ç·£', 'ç¼š': 'ç¸›', 'ç¼': 'ç¸«', 'ç¼ ': 'çº',
    'ç¼¤': 'ç¹½', 'ç¼¨': 'çº“', 'ç¼©': 'ç¸®', 'ç¼­': 'ç¹š', 'ç¼°': 'éŸ',
    'ç¼´': 'ç¹³', 'ç½': 'ç½', 'ç½‘': 'ç¶²', 'ç½—': 'ç¾…', 'ç½š': 'ç½°',
    'ç½¢': 'ç½·', 'ç¿…': 'ç¿…', 'ç¿”': 'ç¿”', 'è€€': 'è€€', 'èŒ': 'è·',
    'è”': 'è¯', 'èª': 'è°', 'è‚ƒ': 'è‚…', 'è‚ ': 'è…¸', 'è‚¤': 'è†š',
    'è‚¿': 'è…«', 'èƒ€': 'è„¹', 'èƒ': 'è„…', 'èƒ†': 'è†½', 'è„‰': 'è„ˆ',
    'è„': 'é«’', 'è„‘': 'è…¦', 'è„š': 'è…³', 'è„±': 'è„«', 'è„¸': 'è‡‰',
    'è…Š': 'è‡˜', 'è…»': 'è†©', 'è…¾': 'é¨°', 'èˆ†': 'è¼¿', 'èˆ°': 'è‰¦',
    'èˆ±': 'è‰™', 'è‰°': 'è‰±', 'è‰º': 'è—', 'èŠ‚': 'ç¯€', 'èŠ¦': 'è˜†',
    'èŠœ': 'è•ª', 'è‹': 'è’¼', 'è‹': 'è˜‡', 'èŒƒ': 'ç¯„', 'èŒ§': 'ç¹­',
    'è': 'è–¦', 'è’': 'è’', 'è¡': 'è•©', 'è£': 'æ¦®', 'è¯': 'è—¥',
    'è²': 'è“®', 'è±': 'èŠ', 'è·': 'ç²', 'è¤': 'è¢', 'è¥': 'ç‡Ÿ',
    'è§': 'è•­', 'è’‹': 'è”£', 'è’™': 'è’™', 'è“': 'è—', 'è’²': 'è’²',
    'è”·': 'è–”', 'è•´': 'è˜Š', 'è–ª': 'è–ª', 'è—': 'è—', 'è™‘': 'æ…®',
    'è™š': 'è™›', 'è™«': 'èŸ²', 'è™½': 'é›–', 'èš€': 'è•', 'è›‡': 'è›‡',
    'è›®': 'è »', 'èœ—': 'è¸', 'èœ¡': 'è Ÿ', 'è‡': 'è …', 'è': 'è ',
    'è´': 'è´', 'èº': 'èº', 'èŸ ': 'èŸ ', 'èŸ¾': 'èŸ¾', 'è¡Œ': 'è¡Œ',
    'è¡¥': 'è£œ', 'è¡¬': 'è¥¯', 'è¢„': 'è¥–', 'è¢‹': 'è¢‹', 'è¢œ': 'è¥ª',
    'è£…': 'è£', 'è£¤': 'è¤²', 'è£¹': 'è£¹', 'è¤': 'è¤', 'è¤´': 'è¥¤',
    'è§ˆ': 'è¦½', 'è§…': 'è¦“', 'è§†': 'è¦–', 'è§‰': 'è¦º', 'è§‚': 'è§€',
    'è§„': 'è¦', 'è§‘': 'è¦·', 'è§’': 'è§’', 'è§£': 'è§£', 'è§¦': 'è§¸',
    'è¨€': 'è¨€', 'èª‰': 'è­½', 'è®¡': 'è¨ˆ', 'è®¢': 'è¨‚', 'è®¤': 'èª',
    'è®¨': 'è¨', 'è®©': 'è®“', 'è®¯': 'è¨Š', 'è®°': 'è¨˜', 'è®²': 'è¬›',
    'è®³': 'è«±', 'è®¸': 'è¨±', 'è®º': 'è«–', 'è®¾': 'è¨­', 'è®¿': 'è¨ª',
    'è¯': 'è­‰', 'è¯„': 'è©•', 'è¯†': 'è­˜', 'è¯Š': 'è¨º', 'è¯': 'è©',
    'è¯‘': 'è­¯', 'è¯•': 'è©¦', 'è¯—': 'è©©', 'è¯š': 'èª ', 'è¯': 'è©±',
    'è¯¥': 'è©²', 'è¯¦': 'è©³', 'è¯­': 'èª', 'è¯¯': 'èª¤', 'è¯´': 'èªª',
    'è¯·': 'è«‹', 'è¯¸': 'è«¸', 'è¯º': 'è«¾', 'è¯»': 'è®€', 'è¯¾': 'èª²',
    'è°ƒ': 'èª¿', 'è°': 'èª°', 'è°ˆ': 'è«‡', 'è°Š': 'èª¼', 'è°‹': 'è¬€',
    'è°“': 'è¬‚', 'è°¢': 'è¬', 'è°£': 'è¬ ', 'è°¦': 'è¬™', 'è°¨': 'è¬¹',
    'è°±': 'è­œ', 'è°·': 'è°·', 'è±†': 'è±†', 'è±¡': 'è±¡', 'è±ª': 'è±ª',
    'è²Œ': 'è²Œ', 'è´Ÿ': 'è² ', 'è´¡': 'è²¢', 'è´¢': 'è²¡', 'è´£': 'è²¬',
    'è´¤': 'è³¢', 'è´¥': 'æ•—', 'è´§': 'è²¨', 'è´¨': 'è³ª', 'è´­': 'è³¼',
    'è´®': 'è²¯', 'è´¯': 'è²«', 'è´°': 'è²³', 'è´±': 'è³¤', 'è´´': 'è²¼',
    'è´µ': 'è²´', 'è´·': 'è²¸', 'è´¸': 'è²¿', 'è´¹': 'è²»', 'èµ': 'è³ƒ',
    'èµ„': 'è³‡', 'èµ‹': 'è³¦', 'èµŒ': 'è³­', 'èµ': 'è³', 'èµ”': 'è³ ',
    'èµ–': 'è³´', 'èµ˜': 'è´…', 'èµ›': 'è³½', 'èµ ': 'è´ˆ', 'èµ¢': 'è´',
    'èµµ': 'è¶™', 'è¶‹': 'è¶¨', 'è·ƒ': 'èº', 'è·µ': 'è¸', 'è¸Š': 'è¸´',
    'è¸ª': 'è¹¤', 'è¹„': 'è¹„', 'è¹¦': 'è¹¦', 'è¹²': 'è¹²', 'èº¯': 'è»€',
    'è½¦': 'è»Š', 'è½§': 'è»‹', 'è½¬': 'è½‰', 'è½®': 'è¼ª', 'è½¯': 'è»Ÿ',
    'è½°': 'è½Ÿ', 'è½»': 'è¼•', 'è½½': 'è¼‰', 'è¾ƒ': 'è¼ƒ', 'è¾…': 'è¼”',
    'è¾†': 'è¼›', 'è¾ˆ': 'è¼©', 'è¾‰': 'è¼', 'è¾‘': 'è¼¯', 'è¾“': 'è¼¸',
    'è¾–': 'è½„', 'è¾—': 'è¼¾', 'è¾™': 'è½', 'è¾': 'è¾­', 'è¾©': 'è¾¯',
    'è¾¹': 'é‚Š', 'è¾¾': 'é”', 'è¿': 'é·', 'è¿‡': 'é', 'è¿ˆ': 'é‚',
    'è¿': 'é‹', 'è¿›': 'é€²', 'è¿œ': 'é ', 'è¿': 'é•', 'è¿': 'é€£',
    'è¿Ÿ': 'é²', 'é€‚': 'é©', 'é€‰': 'é¸', 'é€Š': 'éœ', 'é€': 'é€',
    'é€’': 'é', 'é€»': 'é‚', 'é—': 'éº', 'é¥': 'é™', 'é‚“': 'é„§',
    'é‚®': 'éƒµ', 'é‚»': 'é„°', 'éƒ‘': 'é„­', 'é…': 'é†', 'é…±': 'é†¬',
    'é…¿': 'é‡€', 'é‡‡': 'æ¡', 'é‡Š': 'é‡‹', 'é‰´': 'é‘’', 'é’‰': 'é‡˜',
    'é’Š': 'é‡—', 'é’ˆ': 'é‡', 'é’“': 'é‡£', 'é’›': 'éˆ¦', 'é’': 'éˆ',
    'é’': 'éˆ”', 'é’Ÿ': 'é˜', 'é’¢': 'é‹¼', 'é’¥': 'é‘°', 'é’¦': 'æ¬½',
    'é’§': 'éˆ', 'é’¨': 'é¢', 'é’©': 'é‰¤', 'é’®': 'éˆ•', 'é’¯': 'éˆ€',
    'é’±': 'éŒ¢', 'é’³': 'é‰—', 'é’´': 'éˆ·', 'é’µ': 'ç¼½', 'é’»': 'é‘½',
    'é“': 'éµ', 'é“ƒ': 'éˆ´', 'é“…': 'é‰›', 'é“†': 'é‰š', 'é“‰': 'é‰‰',
    'é“œ': 'éŠ…', 'é“': 'é‹', 'é“ ': 'é§', 'é“¡': 'é˜', 'é“£': 'éŠ‘',
    'é“¤': 'é‹Œ', 'é“­': 'éŠ˜', 'é“¸': 'é‘„', 'é“º': 'é‹ª', 'é“¾': 'éˆ',
    'é”': 'é–', 'é”‚': 'é‹°', 'é”…': 'é‹', 'é”†': 'é‹¯', 'é”ˆ': 'éŠ¹',
    'é”‰': 'éŠ¼', 'é”‹': 'é‹’', 'é”Œ': 'é‹…', 'é”': 'é§', 'é”': 'éŠ³',
    'é”—': 'éº', 'é”™': 'éŒ¯', 'é”¡': 'éŒ«', 'é”¢': 'éŒ®', 'é”£': 'é‘¼',
    'é”¤': 'éŒ˜', 'é”¥': 'éŒ', 'é”¦': 'éŒ¦', 'é”¨': 'é', 'é”­': 'éŒ ',
    'é”®': 'éµ', 'é”¯': 'é‹¸', 'é”°': 'éŒ³', 'é”²': 'é¥', 'é”»': 'é›',
    'é•‡': 'é®', 'é•Š': 'é‘·', 'é•': 'é¬', 'é•‘': 'éŠ', 'é•–': 'é¢',
    'é•œ': 'é¡', 'é•£': 'é', 'é•°': 'é®', 'é—ª': 'é–ƒ', 'é—­': 'é–‰',
    'é—®': 'å•', 'é—°': 'é–', 'é—»': 'è', 'é—½': 'é–©', 'é˜€': 'é–¥',
    'é˜': 'é–£', 'é˜…': 'é–±', 'é˜”': 'é—Š', 'é˜™': 'é—•', 'é˜š': 'é—',
    'é˜¡': 'é˜¡', 'é˜µ': 'é™£', 'é˜¶': 'éš', 'é˜»': 'é˜»', 'é™…': 'éš›',
    'é™†': 'é™¸', 'é™ˆ': 'é™³', 'é™‰': 'é™˜', 'é™•': 'é™', 'é™¨': 'éš•',
    'é™©': 'éšª', 'éš': 'éš¨', 'éš': 'éš±', 'éš¶': 'éš¸', 'é›‡': 'åƒ±',
    'é›': 'é››', 'é›³': 'é‚', 'é›¾': 'éœ§', 'éœ': 'éœ½', 'éœ„': 'éœ„',
    'éœœ': 'éœœ', 'é™': 'éœ', 'é ': 'é ', 'é‘': 'éŸƒ', 'éŸ¦': 'éŸ‹',
    'éŸ©': 'éŸ“', 'éŸµ': 'éŸ»', 'é¡¹': 'é …', 'é¡¶': 'é ‚', 'é¡·': 'é ƒ',
    'é¡º': 'é †', 'é¡»': 'é ˆ', 'é¡½': 'é ‘', 'é¡¾': 'é¡§', 'é¢': 'é ’',
    'é¢‚': 'é Œ', 'é¢„': 'é ', 'é¢…': 'é¡±', 'é¢†': 'é ˜', 'é¢‡': 'é —',
    'é¢‘': 'é »', 'é¢“': 'é ¹', 'é¢—': 'é¡†', 'é¢˜': 'é¡Œ', 'é¢œ': 'é¡',
    'é¢': 'é¡', 'é¢ ': 'é¡›', 'é¢¤': 'é¡«', 'é£': 'é¢¨', 'é£™': 'é£†',
    'é£': 'é£›', 'é¥¥': 'é£¢', 'é¥¨': 'é£©', 'é¥­': 'é£¯', 'é¥®': 'é£²',
    'é¥°': 'é£¾', 'é¥±': 'é£½', 'é¥²': 'é£¼', 'é¥º': 'é¤ƒ', 'é¥¼': 'é¤…',
    'é¦…': 'é¤¡', 'é¦†': 'é¤¨', 'é¦ˆ': 'é¥‹', 'é¦’': 'é¥…', 'é©®': 'é¦±',
    'é©¯': 'é¦´', 'é©°': 'é¦³', 'é©±': 'é©…', 'é©³': 'é§', 'é©´': 'é©¢',
    'é©¶': 'é§›', 'é©¹': 'é§’', 'é©»': 'é§', 'é©¼': 'é§', 'é©¾': 'é§•',
    'éª‚': 'ç½µ', 'éª„': 'é©•', 'éªŒ': 'é©—', 'éª†': 'é§±', 'éª‡': 'é§­',
    'éª‘': 'é¨', 'éª—': 'é¨™', 'éªš': 'é¨·', 'éª': 'é¨«', 'éª¤': 'é©Ÿ',
    'éª¥': 'é©¥', 'éª¨': 'éª¨', 'é«…': 'é«', 'é¬¼': 'é¬¼', 'é­…': 'é­…',
    'é­‡': 'é­˜', 'é±¼': 'é­š', 'é²': 'é­¯', 'é²ˆ': 'é±¸', 'é²': 'é®‘',
    'é²›': 'é®«', 'é²œ': 'é®®', 'é²¤': 'é¯‰', 'é²¨': 'é¯Š', 'é²«': 'é¯½',
    'é²¸': 'é¯¨', 'é²·': 'é¯›', 'é³„': 'é±·', 'é³—': 'é°»', 'é³': 'é±—',
    'é¸Ÿ': 'é³¥', 'é¸ ': 'é³©', 'é¸¡': 'é›', 'é¸¢': 'é³¶', 'é¸£': 'é³´',
    'é¸¥': 'é·—', 'é¸¦': 'é´‰', 'é¸­': 'é´¨', 'é¸µ': 'é´•', 'é¸½': 'é´¿',
    'é¹ƒ': 'éµ‘', 'é¹…': 'éµ', 'é¹ˆ': 'éµœ', 'é¹‰': 'éµ¡', 'é¹Š': 'éµ²',
    'é¹': 'éµ¬', 'é¹˜': 'é¶»', 'é¹¤': 'é¶´', 'é¹¦': 'é¸š', 'é¹«': 'é·²',
    'é¹°': 'é·¹', 'é¹¿': 'é¹¿', 'éº¦': 'éº¥', 'éº»': 'éº»', 'é»„': 'é»ƒ',
    'é¼': 'é¼', 'é¼“': 'é¼“', 'é¼ ': 'é¼ ', 'é¼¹': 'é¼´', 'é½': 'é½Š',
    'é½¿': 'é½’', 'é¾„': 'é½¡', 'é¾™': 'é¾', 'é¾Ÿ': 'é¾œ',
    # FF14 ç‰¹æ®Šç”¨èª
    'æ‚è´§': 'é›œè²¨', 'å® ç‰©': 'å¯µç‰©', 'åéª‘': 'åé¨',
}

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%H:%M:%S'
)


def convert_simplified_to_traditional(text):
    """
    å°‡ç°¡é«”ä¸­æ–‡æ–‡å­—è½‰æ›ç‚ºç¹é«”ä¸­æ–‡ã€‚
    ä½¿ç”¨å…§å»ºå°ç…§è¡¨ï¼Œé€å­—æ›¿æ›ã€‚
    """
    if not text:
        return text
    result = []
    for char in text:
        result.append(SIMPLIFIED_TO_TRADITIONAL.get(char, char))
    return ''.join(result)


def create_session():
    """å»ºç«‹å¸¶æœ‰é‡è©¦æ©Ÿåˆ¶çš„ HTTP Session"""
    session = requests.Session()
    session.headers.update({
        "User-Agent": "FF14MarketApp-CacheUpdater/1.0",
        "Accept": "application/json",
    })
    retries = Retry(total=3, backoff_factor=1, status_forcelist=[500, 502, 503, 504])
    adapter = HTTPAdapter(max_retries=retries, pool_connections=5, pool_maxsize=5)
    session.mount("https://", adapter)
    session.mount("http://", adapter)
    return session


def fetch_item_by_id(session, item_id):
    """å¾ Cafemaker API æŠ“å–å–®ä¸€ç‰©å“è³‡æ–™"""
    url = f"https://cafemaker.wakingsands.com/Item/{item_id}"
    try:
        resp = session.get(url, timeout=10)
        if resp.status_code == 200:
            data = resp.json()
            name = data.get("Name", "")
            name_ja = data.get("Name_ja", "")
            return {"id": item_id, "name": name, "name_ja": name_ja}
    except Exception as e:
        logging.warning(f"æŠ“å–ç‰©å“ {item_id} å¤±æ•—: {e}")
    return None


def fetch_items_batch(session, start_id, end_id, progress_callback=None):
    """
    æ‰¹é‡æŠ“å–ç‰©å“è³‡æ–™ï¼ˆç¯„åœï¼‰ã€‚
    è·³éç„¡åç¨±çš„ç‰©å“ã€‚
    """
    results = {}
    total = end_id - start_id + 1
    batch_size = 100  # æ¯æ‰¹æŸ¥è©¢çš„ ID æ•¸é‡

    for batch_start in range(start_id, end_id + 1, batch_size):
        batch_end = min(batch_start + batch_size - 1, end_id)
        ids = list(range(batch_start, batch_end + 1))
        ids_str = ",".join(str(i) for i in ids)

        # ä½¿ç”¨æ‰¹é‡ APIï¼ˆå¦‚æœæ”¯æ´ï¼‰
        # Cafemaker ä¸æ”¯æ´æ‰¹é‡ Item APIï¼Œéœ€é€å€‹æŸ¥è©¢
        for item_id in ids:
            data = fetch_item_by_id(session, item_id)
            if data and data["name"]:
                results[item_id] = data

            if progress_callback:
                done = item_id - start_id + 1
                progress_callback(done, total)

        # é¿å…éåº¦è«‹æ±‚
        time.sleep(0.1)

    return results


def search_items_by_name(session, query, limit=100):
    """é€é Cafemaker æœå°‹ API æœå°‹ç‰©å“"""
    url = f"https://cafemaker.wakingsands.com/search?indexes=Item&string={query}&limit={limit}"
    try:
        resp = session.get(url, timeout=15)
        if resp.status_code == 200:
            data = resp.json()
            results = data.get("Results", [])
            return [(r.get("ID"), r.get("Name", "")) for r in results]
    except Exception as e:
        logging.warning(f"æœå°‹ '{query}' å¤±æ•—: {e}")
    return []


# è—å¯¶åœ– G ç·¨è™Ÿæ˜ å°„è¡¨
TREASURE_MAP_G_MAPPING = {
    6688:  "G1",   # é£é©
    6689:  "G2",   # å±±ç¾Šé©
    6690:  "G3",   # å·¨èŸ¾èœé©
    6691:  "G4",   # é‡è±¬é©
    6692:  "G5",   # æ¯’èœ¥èœ´é©
    12241: "G6",   # å¤é³¥é©
    12242: "G7",   # é£›é¾é©
    12243: "G8",   # å·¨é¾é©
    17835: "G9",   # è¿¦è¿¦ç´æ€ªé³¥é©
    17836: "G10",  # çªç¾šé©
    26744: "G11",  # ç¶ é£„é¾é©
    26745: "G12",  # çºå°¾è›Ÿé©
    36611: "G13",  # è³½åŠ ç¾šç¾Šé©
    36612: "G14",  # é‡‘æ¯—ç¾…é±·é©
    39591: "G15",  # è›‡ç‰›é©
    43556: "G16",  # éŠ€ç‹¼é©
    43557: "G17",  # ç°è±¹é©
}


def add_treasure_map_aliases(by_name, dry_run=False):
    """ç‚ºè—å¯¶åœ–æ–°å¢ G ç·¨è™Ÿåˆ¥å"""
    added = 0
    for item_id, g_code in TREASURE_MAP_G_MAPPING.items():
        alias = f"é™³èˆŠçš„åœ°åœ–{g_code}"
        if alias not in by_name:
            if not dry_run:
                by_name[alias] = item_id
            logging.info(f"[è—å¯¶åœ–] æ–°å¢åˆ¥å: {alias} â†’ ID:{item_id}")
            added += 1
        # ä¹Ÿæª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°çš„ G ç·¨è™Ÿï¼ˆå¦‚æœªä¾† API æ›´æ–°ï¼‰
    
    logging.info(f"è—å¯¶åœ–åˆ¥åè™•ç†å®Œæˆï¼Œæ–°å¢ {added} å€‹")
    return added


def update_cache_incremental(session, existing_data, max_id=50000, dry_run=False):
    """
    å¢é‡æ›´æ–°æ¨¡å¼ï¼š
    1. æ‰¾å‡ºç¾æœ‰å¿«å–ä¸­æœ€å¤§çš„ Item ID
    2. åªæŠ“å–æ¯”æœ€å¤§ ID æ›´æ–°çš„ç‰©å“
    3. è½‰æ›ç‚ºç¹é«”ä¸­æ–‡å¾ŒåŠ å…¥å¿«å–
    """
    by_name = existing_data.get("by_name", {})
    
    # æ‰¾å‡ºç¾æœ‰æœ€å¤§ ID
    current_max_id = max(by_name.values()) if by_name else 0
    logging.info(f"ç¾æœ‰å¿«å–æœ€å¤§ ID: {current_max_id}")
    
    if current_max_id >= max_id:
        logging.info("å¿«å–å·²æ˜¯æœ€æ–°ï¼Œç„¡éœ€æ›´æ–°")
        return 0
    
    # å¾æœ€å¤§ ID + 1 é–‹å§‹æŠ“å–
    start_id = current_max_id + 1
    logging.info(f"é–‹å§‹å¢é‡æ›´æ–°: ID {start_id} ~ {max_id}")
    
    new_count = 0
    batch_size = 500
    
    consecutive_empty = 0  # é€£çºŒç©ºç™½è¨ˆæ•¸
    max_consecutive_empty = 200  # é€£çºŒ 200 å€‹ç©º ID å‰‡åœæ­¢
    
    for batch_start in range(start_id, max_id + 1, batch_size):
        batch_end = min(batch_start + batch_size - 1, max_id)
        
        for item_id in range(batch_start, batch_end + 1):
            data = fetch_item_by_id(session, item_id)
            
            if data and data["name"]:
                consecutive_empty = 0
                # ç°¡é«” â†’ ç¹é«”è½‰æ›
                tw_name = convert_simplified_to_traditional(data["name"])
                
                if tw_name not in by_name:
                    if not dry_run:
                        by_name[tw_name] = item_id
                    logging.info(f"[æ–°å¢] ID:{item_id} â†’ {tw_name}")
                    new_count += 1
            else:
                consecutive_empty += 1
                if consecutive_empty >= max_consecutive_empty:
                    logging.info(f"é€£çºŒ {max_consecutive_empty} å€‹ç©º IDï¼Œåœæ­¢æƒæï¼ˆè‡³ ID:{item_id}ï¼‰")
                    break
            
            # é€²åº¦é¡¯ç¤º
            if (item_id - start_id + 1) % 100 == 0:
                logging.info(f"é€²åº¦: ID {item_id} / {max_id} ({new_count} å€‹æ–°ç‰©å“)")
            
            time.sleep(0.05)  # é¿å… API éè¼‰
        
        if consecutive_empty >= max_consecutive_empty:
            break
    
    logging.info(f"å¢é‡æ›´æ–°å®Œæˆï¼Œå…±æ–°å¢ {new_count} å€‹ç‰©å“")
    return new_count


def update_cache_full(session, max_id=50000, dry_run=False):
    """
    å®Œæ•´é‡å»ºæ¨¡å¼ï¼š
    å¾ ID 1 é–‹å§‹æŠ“å–æ‰€æœ‰ç‰©å“ï¼Œå»ºç«‹å…¨æ–°çš„å¿«å–ã€‚
    âš ï¸ è­¦å‘Šï¼šé€™æœƒéå¸¸æ…¢ï¼å¯èƒ½éœ€è¦æ•¸å°æ™‚ã€‚
    """
    logging.warning("å®Œæ•´é‡å»ºæ¨¡å¼å•Ÿå‹•ï¼é€™å¯èƒ½éœ€è¦æ•¸å°æ™‚...")
    
    by_name = {}
    new_count = 0
    consecutive_empty = 0
    max_consecutive_empty = 500
    
    for item_id in range(1, max_id + 1):
        data = fetch_item_by_id(session, item_id)
        
        if data and data["name"]:
            consecutive_empty = 0
            tw_name = convert_simplified_to_traditional(data["name"])
            
            if tw_name not in by_name:
                if not dry_run:
                    by_name[tw_name] = item_id
                new_count += 1
        else:
            consecutive_empty += 1
            if consecutive_empty >= max_consecutive_empty:
                logging.info(f"é€£çºŒ {max_consecutive_empty} å€‹ç©º IDï¼Œåœæ­¢ï¼ˆè‡³ ID:{item_id}ï¼‰")
                break
        
        if item_id % 500 == 0:
            logging.info(f"é€²åº¦: ID {item_id} / {max_id} ({new_count} å€‹ç‰©å“)")
        
        time.sleep(0.05)
    
    logging.info(f"å®Œæ•´é‡å»ºå®Œæˆï¼Œå…± {new_count} å€‹ç‰©å“")
    return {"by_name": by_name}


def update_existing_names(session, existing_data, dry_run=False):
    """
    æ›´æ–°ç¾æœ‰ç‰©å“åç¨±ï¼š
    å°ç¾æœ‰å¿«å–ä¸­çš„æ¯å€‹ç‰©å“é‡æ–°å¾ API å–å¾—åç¨±ï¼Œ
    ä¸¦é€²è¡Œç°¡ç¹è½‰æ›ï¼Œå¦‚æœåç¨±æœ‰è®Šæ›´å‰‡æ›´æ–°ã€‚
    é©ç”¨æ–¼éŠæˆ²æ”¹ç‰ˆå¾Œç‰©å“åç¨±è¢«æ›´æ–°çš„æƒ…æ³ã€‚
    """
    by_name = existing_data.get("by_name", {})
    
    # å»ºç«‹ ID â†’ åç¨± çš„åå‘æ˜ å°„
    id_to_names = {}
    for name, item_id in by_name.items():
        if item_id not in id_to_names:
            id_to_names[item_id] = []
        id_to_names[item_id].append(name)
    
    total = len(id_to_names)
    updated = 0
    checked = 0
    
    logging.info(f"é–‹å§‹æª¢æŸ¥ {total} å€‹ç‰©å“çš„åç¨±æ›´æ–°...")
    
    for item_id in sorted(id_to_names.keys()):
        checked += 1
        data = fetch_item_by_id(session, item_id)
        
        if data and data["name"]:
            tw_name = convert_simplified_to_traditional(data["name"])
            
            # æª¢æŸ¥è½‰æ›å¾Œçš„åç¨±æ˜¯å¦å·²å­˜åœ¨
            if tw_name not in by_name:
                if not dry_run:
                    by_name[tw_name] = item_id
                logging.info(f"[æ›´æ–°] ID:{item_id} æ–°å¢åç¨±: {tw_name}")
                updated += 1
        
        if checked % 200 == 0:
            logging.info(f"é€²åº¦: {checked}/{total} ({updated} å€‹æ›´æ–°)")
        
        time.sleep(0.05)
    
    logging.info(f"åç¨±æ›´æ–°å®Œæˆï¼Œå…±æ›´æ–° {updated} å€‹")
    return updated


def main():
    parser = argparse.ArgumentParser(
        description="FF14 ç‰©å“å¿«å–è‡ªå‹•æ›´æ–°å·¥å…·",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ç¯„ä¾‹ï¼š
  python update_items_cache.py              # å¢é‡æ›´æ–°ï¼ˆåªæŠ“å–æ–°ç‰©å“ï¼‰
  python update_items_cache.py --full       # å®Œæ•´é‡å»ºï¼ˆéå¸¸æ…¢ï¼‰
  python update_items_cache.py --maps-only  # åªæ›´æ–°è—å¯¶åœ–åˆ¥å
  python update_items_cache.py --dry-run    # é è¦½æ¨¡å¼ï¼ˆä¸å¯«å…¥æª”æ¡ˆï¼‰
  python update_items_cache.py --update-names  # æ›´æ–°ç¾æœ‰ç‰©å“åç¨±
  python update_items_cache.py --convert-only  # åªåšç°¡ç¹è½‰æ›ï¼ˆä¸æŠ“APIï¼‰
        """
    )
    parser.add_argument("--full", action="store_true", help="å®Œæ•´é‡å»ºå¿«å–ï¼ˆéå¸¸æ…¢ï¼‰")
    parser.add_argument("--maps-only", action="store_true", help="åªæ›´æ–°è—å¯¶åœ– G ç·¨è™Ÿåˆ¥å")
    parser.add_argument("--dry-run", action="store_true", help="é è¦½æ¨¡å¼ï¼Œä¸å¯«å…¥æª”æ¡ˆ")
    parser.add_argument("--update-names", action="store_true", help="æ›´æ–°ç¾æœ‰ç‰©å“åç¨±ï¼ˆæª¢æŸ¥æ”¹åï¼‰")
    parser.add_argument("--convert-only", action="store_true", help="åªå°ç¾æœ‰å¿«å–åšç°¡ç¹è½‰æ›")
    parser.add_argument("--max-id", type=int, default=50000, help="æœ€å¤§æƒæ IDï¼ˆé è¨­: 50000ï¼‰")
    parser.add_argument("--json-file", default="items_cache_tw.json", help="å¿«å– JSON æª”æ¡ˆè·¯å¾‘")
    
    args = parser.parse_args()
    
    json_file = args.json_file
    
    # è®€å–ç¾æœ‰å¿«å–
    if os.path.exists(json_file):
        with open(json_file, "r", encoding="utf-8") as f:
            data = json.load(f)
        logging.info(f"å·²è¼‰å…¥ {json_file}ï¼Œå…± {len(data.get('by_name', {}))} å€‹ç‰©å“")
    else:
        data = {"by_name": {}}
        logging.info("æœªæ‰¾åˆ°å¿«å–æª”æ¡ˆï¼Œå°‡å»ºç«‹æ–°æª”æ¡ˆ")
    
    changes_made = 0
    
    # æ¨¡å¼åˆ¤æ–·
    if args.convert_only:
        # åªåšç°¡ç¹è½‰æ›
        logging.info("=== ç°¡ç¹è½‰æ›æ¨¡å¼ ===")
        by_name = data["by_name"]
        new_entries = {}
        for name, item_id in list(by_name.items()):
            tw_name = convert_simplified_to_traditional(name)
            if tw_name != name:
                new_entries[tw_name] = item_id
                logging.info(f"[è½‰æ›] {name} â†’ {tw_name} (ID:{item_id})")
                changes_made += 1
        
        if not args.dry_run:
            by_name.update(new_entries)
        logging.info(f"ç°¡ç¹è½‰æ›å®Œæˆï¼Œå…± {changes_made} å€‹åç¨±éœ€è¦æ–°å¢ç¹é«”ç‰ˆæœ¬")
    
    elif args.maps_only:
        # åªæ›´æ–°è—å¯¶åœ–
        logging.info("=== è—å¯¶åœ–åˆ¥åæ›´æ–°æ¨¡å¼ ===")
        changes_made = add_treasure_map_aliases(data["by_name"], dry_run=args.dry_run)
    
    elif args.full:
        # å®Œæ•´é‡å»º
        logging.info("=== å®Œæ•´é‡å»ºæ¨¡å¼ ===")
        session = create_session()
        data = update_cache_full(session, max_id=args.max_id, dry_run=args.dry_run)
        add_treasure_map_aliases(data["by_name"], dry_run=args.dry_run)
        changes_made = len(data.get("by_name", {}))
    
    elif args.update_names:
        # æ›´æ–°åç¨±
        logging.info("=== åç¨±æ›´æ–°æ¨¡å¼ ===")
        session = create_session()
        changes_made = update_existing_names(session, data, dry_run=args.dry_run)
        changes_made += add_treasure_map_aliases(data["by_name"], dry_run=args.dry_run)
    
    else:
        # å¢é‡æ›´æ–°ï¼ˆé è¨­ï¼‰
        logging.info("=== å¢é‡æ›´æ–°æ¨¡å¼ ===")
        session = create_session()
        changes_made = update_cache_incremental(
            session, data, max_id=args.max_id, dry_run=args.dry_run
        )
        changes_made += add_treasure_map_aliases(data["by_name"], dry_run=args.dry_run)
    
    # å¯«å…¥æª”æ¡ˆ
    if changes_made > 0 and not args.dry_run:
        # å‚™ä»½åŸæª”
        if os.path.exists(json_file):
            backup_name = f"{json_file}.backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
            os.rename(json_file, backup_name)
            logging.info(f"åŸæª”å·²å‚™ä»½ç‚º: {backup_name}")
        
        with open(json_file, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=8)
        
        total_items = len(data.get("by_name", {}))
        logging.info(f"âœ… æ›´æ–°å®Œæˆï¼{json_file} ç¾æœ‰ {total_items} å€‹ç‰©å“æ¢ç›®")
    elif args.dry_run:
        logging.info(f"ğŸ“‹ é è¦½æ¨¡å¼ï¼šå…± {changes_made} å€‹è®Šæ›´ï¼ˆæœªå¯«å…¥æª”æ¡ˆï¼‰")
    else:
        logging.info("â„¹ï¸ ç„¡éœ€æ›´æ–°")
    
    # æ¸…ç†è‡¨æ™‚è…³æœ¬
    cleanup_script = os.path.join(os.path.dirname(os.path.abspath(__file__)), "add_map_aliases.py")
    if os.path.exists(cleanup_script):
        logging.info(f"æç¤º: èˆŠè…³æœ¬ add_map_aliases.py ä»å­˜åœ¨ï¼Œå·²è¢«æœ¬å·¥å…·å–ä»£ï¼Œå¯å®‰å…¨åˆªé™¤")


if __name__ == "__main__":
    main()
